---
title: 'Air Toxics Data and R: Zero to Shiny'
author: "Kali Frost and Nathan Byers"
date: "October 26, 2015"
output:
  ioslides_presentation:
    widescreen: true
    fig_caption: true
runtime: shiny
---

## Who we are

- Nathan Byers, Kali Frost, and Eric Bailey (_in absentia_)
- Former employees at the Indiana Department of Environmental Management
- Experienced data analysts and R programmers
- R enthusiests

![](images/renthusiast.jpg)

## What this is 

<div class="columns-2">
- R presentation using [ioslides](http://rmarkdown.rstudio.com/ioslides_presentation_format.html)
- Follow along at https://ebailey78.shinyapps.io/epaToxicsPresentation
- Source code is on [GitHub](https://github.com/NateByers/epaToxicsTraining) and is entirely reproducible

![https://xkcd.com/242/](images/xkcd.png)
</div>


## Training Outline

* What is R and RStudio
* R basics
* The Hadleyverse
    + `dplyr`
    + `tidyr`
    + `ggplot2`
* Useful packages for air toxics
    + `raqdm`
    + `rucl`
    + `openair`
* Air toxics analysis demo
* Interactive web app with `shiny`

<div class="notes">
Presentation should last 50 to 60 minutes.

</div>

# What is R and RStudio

## The R Project   ![](images/Rlogo.png)

- R is free and open-source software for statistical computing and graphics
- [Download here](https://www.r-project.org/)
- Itâ€™s been very popular in academia for more than a decade
- Statisitcal software that can do complex analyses using built-in functions, similar to SAS
- Also a programming language that is extendable (i.e. you can write your own functions/software)

## Popularity

- Originally written by statisticians for statisticians
- Now widely used in academia (not just stats departments)
- Making headway into government and industry, especially the biotech and finance sectors. 
- Here is a [link](http://r4stats.com/articles/popularity/) describing the increasing popularity of R.

## ![](images/RStudio.png)

- After you download R, you may want to use an integrated development environment (IDE) like
RStudio 
- An IDE makes R a little more user friendly
- RStudio is free and can be downloaded at [rstudio.com](https://www.rstudio.com/)

## ![](images/RStudio.png)

![](images/rstudio_screen.png)

## Training Outline

* <font color="#D9D9D9">What is R and RStudio</font>
* R basics
* <font color="#D9D9D9">The Hadleyverse</font>
    + <font color="#D9D9D9">dplyr</font>
    + <font color="#D9D9D9">tidyr</font>
    + <font color="#D9D9D9">ggplot2</font>
* <font color="#D9D9D9">Useful packages for air toxics</font>
    + <font color="#D9D9D9">raqdm</font>
    + <font color="#D9D9D9">rucl</font>
    + <font color="#D9D9D9">openair</font>
* <font color="#D9D9D9">Air toxics analysis demo</font>
* <font color="#D9D9D9">Interactive web app with shiny</font>

## R Basics - Command line

- R is a language and an environment
- By "language" we mean there is a syntax, or a certain way to type letters, 
words, numbers, and other symbols
- You type in the "command line" and hit enter to do something, in contrast to
pointing and clicking to do something

![](images/command_line.png)

## R Basics - Command line 

- In this presentation, command line code will be shown in blocks with gray 
background shading

- The output will be shown in a separate block below the command line input
with a lighter shadow and `##` at the beginning of each line

```{r}
"command line"
1 + 1
```

## R Basics - Math

As we demonstrated in the previous slide, you can use R as a simple calculator

```{r}
3 - 1
2 * 2
10 / 5
log(10)
```

## R Basics - Variables

We can store numbers and text in variables

```{r}
x <- 1
x
x <- 10
x
y <- 2
x * y
```

## R Basics - Variables

```{r}
pollutant <- "benzene"
pollutant
pollutant <- "toluene"
pollutant
```

## R Basics - Vectors

- A series of numbers or text values and be stored together in a vector
- The container for a vector is `c( )`

```{r}
c(1, 2, 3)
x <- c(5, 6, 7)
x
z <- c("mercury", "cadmium")
z
```

## R Basics - Functions

- Variables and vectors contain data
- Functions do stuff to data
- You recongnize a function by parentheses `( )`

```{r}
x <- c(1, 2, 3, 3, 4, 5, 5, 6, 7, 7, 7)
mean(x)
median(x)
```

## R Basics - Functions

- To find out how to use a function, type `?` then the function name
- Below is an image of what you see in RStudio if you type `?mean` and hit return

![](images/mean_documentation.png)


## R Basics - Data Frames

- A data frame is a collection of vectors with the same length
- Basically a spreadsheet

```{r}
pollutant <- c("benzene", "acrolein")
value <- c(.7, .8)
unit <- c("ug/m^3", "ug/m^3")
df <- cbind(pollutant, value, unit)
df
```

## R Basics - Data Objects and Functions

- Those are the basic type of objects you'll need to be familiar with to understand this training/demonstration
- Vectors and data frames store numbers and text (a variable with a single value
is actually just a vector of length 1)
- Functions do things to vectors and data frames then return an output

## R Basics - Loading/installing packages

- R comes with functions immediately available
- Some functions come with R, but they are only available after loading a package using `library()`

```{r, eval = FALSE}
library(lattice)
```

- Some packages do not come with an R download
- Packages that are on [CRAN](https://cran.r-project.org/) can be downloaded and installed using `install.packages()`

```{r, eval=FALSE}
install.packages("devtools")
```

## R Basics - Installing from GitHub ![GitHub](images/GitHub-Mark/GitHub-Mark/PNG/GitHub-Mark-64px.png)

- You may want to use a package that isn't on CRAN 
- Many R developers put their packages on GitHub 

![](images/githubrepo.png)

## R Basics - Installing from GitHub ![GitHub](images/GitHub-Mark/GitHub-Mark/PNG/GitHub-Mark-64px.png)

- To install a package from GitHub, load the devtools package

```{r, eval=FALSE}
library(devtools)
```

- Then use the `install_github()` function by specifying the user name and the repository

```{r, eval=FALSE}
install_github("ramnathv/rCharts")
```

## Training Outline

* <font color="#D9D9D9">What is R and RStudio</font>
* <font color="#D9D9D9">R basics</font>
* The Hadleyverse
    + `dplyr`
    + `tidyr`
    + `ggplot2`
* <font color="#D9D9D9">Useful packages for air toxics</font>
    + <font color="#D9D9D9">raqdm</font>
    + <font color="#D9D9D9">rucl</font>
    + <font color="#D9D9D9">openair</font>
* <font color="#D9D9D9">Air toxics analysis demo</font>
* <font color="#D9D9D9">Interactive web app with shiny</font>


## The Hadleyverse {.columns-2}

- The Hadleyverse is a collection of packages written by
[Hadley Wickham](http://had.co.nz/)
- These packages make R much easier to use
- We will introduce three useful packages for data manipulation (`dplyr`),
reshaping data (`tidyr`), and data visualization (`ggplot2`)

![http://adolfoalvarez.cl/the-hitchhikers-guide-to-the-hadleyverse/](images/hadleyverse.png)

# Data manipulation with `dplyr`

## `dplyr` - Overview

- A very handy data manipulation package
- Very fast (much of it is written in C++)
- Can work with tables from databases
- Main functions are `filter()`, `summarize()`, and `mutate()`
- These main functions take a data frame as input and return 
a data frame as output

## `dplyr` - Data

Below is a data frame that will be used to easily visualize
`dplyr` operations

```{r}
tox <- read.table(header=T, text='
  monitor  parameter       day   hour  value  limit              
        A    benzene  20140601  08:00   4.72   16.3
        A    benzene  20140601  09:00   5.84   16.3
        A    benzene  20140602  08:00  21.12   16.3  
        A    benzene  20140602  09:00   8.94   16.3
        B    benzene  20140601  08:00   0.61   16.3
        B    benzene  20140601  09:00   0.70   16.3
        B    benzene  20140602  08:00   0.99   16.3
        B    benzene  20140602  09:00   1.70   16.3
        A    toluene  20140601  08:00  76.10   75.0
        A    toluene  20140601  09:00   2.51   75.0
                       ')
```


## `dplyr` - Filtering

- The first argument of `filter()` is a data frame, `filter(tox, ...)`
- The data frame can then be filters using logical expressions
- Here we filter the `tox` data frame so that we just get values from monitor A

```{r, message=FALSE, warning=FALSE}
library(dplyr)
filter(tox, monitor == "A")
```

## `dplyr` - Filtering

- You can enter more than one logical expression separated by a comma

```{r}
filter(tox, monitor == "B", value > 1)
```

- This is equivalent to using the `&` operator

```{r}
filter(tox, monitor == "B" & value > 1)
```

## `dplyr` - Filtering

Again, the total number of columns is preserved in the output of
`filter()`

```{r}
# output of dim() is c(number-of-rows, number-of-columns)
dim(tox)
dim(filter(tox, day == "20140602"))
```

## `dplyr` - Summarize

- The first argument of `summarize()` is also a data frame
- However, the input data frame requires grouping information
- For example, if we wanted to summarize the `tox` data frame by 
returning daily averages for each pollutant, we need to group the 
data frame by `monitor`, `parameter`, and `day`

```{r}
head(tox)
```

## `dplyr` - Summarize

- We add grouping information by using the `group_by()` function

```{r}
tox_daily <- group_by(tox, monitor, parameter, day)
```

- Now we feed this data frame to the summary function, `summarize(tox_daily, ...)`
- To get daily averages, we also supply a function that will return the mean, and 
we name it `daily_mean` (obviously not a true daily mean, with only a few hours...)

```{r, eval=FALSE}
summarize(tox_daily, daily_mean = mean(value))
```

## `dplyr` - Summarize


```{r, echo=FALSE}
summarize(tox_daily, daily_mean = mean(value))
```

## `dplyr` - Summarize

We could summarize the data down to an even smaller/simpler data frame
that gives us the number of parameters measured for each monitor

```{r}
tox_monitors <- group_by(tox, monitor)
summarize(tox_monitors, number_of_parameters = length(unique(parameter)))
```

## `dplyr` - Add Columns

- You can add new columns to a data frame by using the `mutate()` function
- The output will have the same number of rows
- The first argument is the input data frame and the subsequent arguments
must be functions that return a single value for each row (i.e. *not* a 
summary function)

```{r, eval=FALSE}
mutate(tox, above_limit = value > limit)
```

## `dplyr` - Add Columns

```{r}
mutate(tox, above_limit = value > limit)
```

## `dplyr` - Add Columns

Here we add more than one column at a time

```{r}
mutate(tox, above_limit = value > limit, limit_diff = value - limit)
```

# Reshape data with `tidyr`

## `tidyr` - Overview {.columns-2}

- `tidyr` is a very simple but very useful package
- Just does two things
    + reshapes wide to long 
    + reshapes long to wide

![](images/long_and_wide.png)

## `tidyr` - Long to Wide

- The `tox` data frame is in a long format
- You can recognize a long format if there is only one column with 
values

```{r}
head(tox)
```

## `tidyr` - Long to Wide

- The `spread()` function takes a long data frame and spreads it
out into a wide data frame
- The first argument is the long data frame
- The second argument is the column name of the key
- The third argument is the column name of the values

```{r, message=FALSE, warning=FALSE}
library(tidyr)
tox_wide <- spread(tox, key = parameter, value = value)
```

## `tidyr` - Long to Wide

```{r}
tox_wide
```

## `tidyr` - Long to Wide

We could also spread the data frame by monitor

```{r}
spread(tox, key = monitor, value = value)
```

## `tidyr` - Wide to Long

- The `gather()` function takes a wide data frame and gathers
the columns into a long data frame
- The first argument is the wide data frame
- The second argument is the name of the key that will be created
- The third argument is the name of the value column that will be created
- The remaining arguments are the names of the columns to be gathered


## `tidyr` - Wide to Long

```{r}
head(tox_wide)
tox_long <- gather(tox_wide, key = pollutant, value = sample_measurement,
                   benzene, toluene)
```
## `tidyr` - Wide to Long

```{r}
tox_long
```

# Visualize data with `ggplot2`

## `ggplot2` - Overview

- Base R does have graphing functions for common plots, such as
scatter plots, line graphs, box plots, and histograms
- `ggplot2` makes it easier to create multi-panel/complex plots

![](images/multipanelggplot.png)

## `ggplot2` - Example Data

For demonstration we'll use the following randomly generated data 

```{r}
rtox <- data.frame(
  date = rep(seq(as.Date("2014-01-01"), by = 6, length = 60), 2),
  monitor = rep(c("A", "B"), each = 60),
  benzene = rgamma(120, shape = 1.5, scale = 3),
  formaldehyde = rgamma(120, shape = 1, scale = 2),
  acrolein = rgamma(120, shape = 1.5, scale = 2.5), 
  p_dichlorobenzene = rgamma(120, shape = 1, scale = 3)
)
head(rtox, 3)

```

## `ggplot2` - Example Data


```{r}
rtox_long <- gather(rtox, parameter, value = sample, benzene:p_dichlorobenzene)
head(rtox)

```

## `ggplot2` - Time Series

- Here is code to make a time series plot of benzene at site A
- The `aes()` parameter is where we specify the x and y axes
- `geom_line()` makes it a line graph

```{r, eval=FALSE}
library(ggplot2)

benzene_A <- filter(rtox_long, parameter == "benzene", monitor == "A")

ggplot(benzene_A, aes(x=date, y=sample)) +
    geom_line() +
    ggtitle("Benzene Time Series 2014")
```


## `ggplot2` - Time Series

```{r, echo=FALSE, warning=FALSE}
library(ggplot2)

benzene_A <- filter(rtox_long, parameter == "benzene", monitor == "A")

ggplot(benzene_A, aes(x=date, y=sample)) +
    geom_line() +
    ggtitle("Benzene Time Series 2014")
```

## `ggplot2` - Time Series

Here we make a time series plot of all pollutants at monitor B

```{r, eval = FALSE}
site_B <- filter(rtox_long, monitor == "B")

ggplot(site_B, aes(x=date, y=sample, color=parameter)) +
    geom_line() +
    ggtitle("Toxics Time Series Monitor B 2014")
```

## `ggplot2` - Time Series

```{r, echo=FALSE, warning = FALSE}
site_B <- filter(rtox_long, monitor == "B")

ggplot(site_B, aes(x=date, y=sample, color=parameter)) +
    geom_line() +
    ggtitle("Toxics Time Series Monitor B 2014")
```

## `ggplot2` - Time Series

Here we plot all toxics data for both monitors


```{r, eval=FALSE}
ggplot(rtox_long, aes(x=date, y=sample, color=parameter)) +
    geom_line() + facet_grid( ~ monitor) +
    ggtitle("Toxics Time Series 2014")
```

## `ggplot2` - Time Series


```{r, warning = FALSE, echo=FALSE, fig.width=11, fig.height=4.5}
ggplot(rtox_long, aes(x=date, y=sample, color=parameter)) +
    geom_line() + facet_grid( ~ monitor) +
    ggtitle("Toxics Time Series 2014")
```

## `ggplot2` - Boxplots

```{r, warning=FALSE}
ggplot(rtox, aes(x=monitor, y=benzene)) + geom_boxplot()
```

## `ggplot2` - Boxplots

```{r}
ggplot(site_B, aes(x=parameter, y=sample)) + geom_boxplot()
```

## `ggplot2` - Boxplots

```{r}
ggplot(rtox_long, aes(x=parameter, y=sample)) + geom_boxplot() + facet_grid( ~ monitor)
```

## `ggplot2` - Histograms

```{r, warning=FALSE, message=FALSE}
ggplot(benzene_A, aes(x=sample)) + geom_histogram()
```

## `ggplot2` - Histograms

```{r, message=FALSE}
ggplot(site_B, aes(x=sample, fill=parameter)) + geom_histogram()
```

## `ggplot2` - Histograms

```{r, message = FALSE}
ggplot(rtox_long, aes(x=sample, fill=parameter)) + geom_histogram() + facet_grid(~ monitor)
```


## Training Outline

* <font color="#D9D9D9">What is R and RStudio</font>
* <font color="#D9D9D9">R basics</font>
* <font color="#D9D9D9">The Hadleyverse</font>
    + <font color="#D9D9D9">dplyr</font>
    + <font color="#D9D9D9">tidyr</font>
    + <font color="#D9D9D9">ggplot2</font>
* Useful packages for air toxics
    + `raqdm`
    + `rucl`
    + `openair`
* <font color="#D9D9D9">Air toxics analysis demo</font>
* <font color="#D9D9D9">Interactive web app with shiny</font>


# Retrieving Data with `raqdm`

## `raqdm` - Overview

- Provides convenient access to US EPA's AQS Data Mart in R
- Makes use of the API discussed at http://www3.epa.gov/airdata/toc.html
- Additional details and sourcecode on GitHub (https://github.com/ebailey78/raqdm)
- Still under development - comments and suggestions welcome (eb11307@gmail.com)

## `raqdm` - Features

- Query AQS Data Mart from the R console or through a convienient GUI.
- Save your most common parameter options so you don't have to enter them repeatedly
- Access to all options available in EPA's web interface
- Import requested data directly into an R data.frame for further analysis
- Synchronous data pulls will be enabled when available from EPA

## `raqdm` - Installation

- `raqdm` isn't currently on CRAN
- To install use the `install_github()` function:

```{r, eval = FALSE}
install_github("ebailey78/raqdm")
library(raqdm)
```


## `raqdm` - Setup

- You will need a username and password from EPA to access the data
- Request username and password from EPA by emailing aqsdatamart@epa.gov
- Once you have user credentials you can save them in `raqdm` with the `setAQDMuser` function 

```{r, eval = FALSE}
setAQDMuser("me@mystate.gov", "my_password", save = TRUE)
```

- You can set other default parameters with the `setAQDMdefaults` function
```{r, eval = FALSE}
setAQDMdefaults(state = "18", bdate = "20140101", edate = "20141231")
```

- Setting `save = TRUE` will cause defaults to be saved across R sessions

## `raqdm` - Requesting Data

- Synchronous data download is not currently enabled on the EPA API.
- We've set defaults for Indiana (18), and bdate(20140101) and edate(20141231) in the previous slide

- Now we can request benzene data with

```{r, eval = FALSE}
benz_req <- getAQDMdata(param = "45201")     # Request benzene
```

- Or We can request all available met data with
```{r, eval = FALSE}
met_req <- getAQDMdata(pc = "MET")
```

## `raqdm` - Retrieving Data

- Once the requests are processed on the server, we read in the data.

```{r, eval=FALSE}
benz <- getAQDMrequest(benz_req)
met <- getAQDMrequest(met_req)
wind_dir <- getAQDMrequest(wind_dir_req)
```


## Training Outline

* <font color="#D9D9D9">What is R and RStudio</font>
* <font color="#D9D9D9">R basics</font>
* <font color="#D9D9D9">The Hadleyverse</font>
    + <font color="#D9D9D9">dplyr</font>
    + <font color="#D9D9D9">tidyr</font>
    + <font color="#D9D9D9">ggplot2</font>
* <font color="#D9D9D9">Useful packages for air toxics</font>
    + <font color="#D9D9D9">raqdm</font>
    + <font color="#D9D9D9">rucl</font>
    + <font color="#D9D9D9">openair</font>
* Air toxics analysis demo
* <font color="#D9D9D9">Interactive web app with shiny</font>

## Training Outline

* <font color="#D9D9D9">What is R and RStudio</font>
* <font color="#D9D9D9">R basics</font>
* <font color="#D9D9D9">The Hadleyverse</font>
    + <font color="#D9D9D9">dplyr</font>
    + <font color="#D9D9D9">tidyr</font>
    + <font color="#D9D9D9">ggplot2</font>
* <font color="#D9D9D9">Useful packages for air toxics</font>
    + <font color="#D9D9D9">raqdm</font>
    + <font color="#D9D9D9">rucl</font>
    + <font color="#D9D9D9">openair</font>
* <font color="#D9D9D9">Air toxics analysis demo</font>
* Interactive web app with `shiny`

## `ui.R`

```{r, eval=FALSE}
library(shiny)
shinyUI(fluidPage(
  titlePanel("Hello Shiny!"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("bins",
                  "Number of bins:",
                  min = 1,
                  max = 50,
                  value = 30)
    ),
    mainPanel(
      plotOutput("distPlot")
    )
  )
))
```

## `server.R`

```{r, eval=FALSE}
library(shiny)
shinyServer(function(input, output) {
  output$distPlot <- renderPlot({
    x    <- faithful[, 2]  # Old Faithful Geyser data
    bins <- seq(min(x), max(x), length.out = input$bins + 1)
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
  })

})
```

## Shiny app

```{r, echo=FALSE}
inputPanel(
  sliderInput("bins",
                  "Number of bins:",
                  min = 1,
                  max = 50,
                  value = 30)
)

renderPlot({
   x    <- faithful[, 2]  # Old Faithful Geyser data
    bins <- seq(min(x), max(x), length.out = input$bins + 1)
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
})
```

